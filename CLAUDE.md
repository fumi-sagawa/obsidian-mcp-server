# CLAUDE.md

このファイルは、このリポジトリでコードを扱う際のClaude Code (claude.ai/code) への指針を提供します。

## 言語設定

このプロジェクトでは**日本語**を基本言語として使用します。コメント、ドキュメント、コミットメッセージなどは日本語で記述してください。

## プロジェクト概要

これは Model Context Protocol (MCP) を通じて気象情報を提供する **Weather MCP Server** です。米国国立気象局 (NWS) API に接続して、気象警報と予報を取得します。

## コマンド

### ビルド
```bash
npm run build              # TypeScriptをコンパイル
```

### 開発
```bash
npm install                # 依存関係のインストール
npm run dev                # 開発モード（ログレベル: debug）
npm run dev:trace          # トレースモード（全ログ出力）
npm run inspector          # MCP Inspector での実行
npm run inspector:debug    # MCP Inspector（デバッグモード）
```

### テスト
```bash
npm run test:alerts        # 警報取得のテスト
npm run test:forecast      # 予報取得のテスト
npm run test:error         # エラーハンドリングのテスト
npm run health-check       # ヘルスチェックの実行
```

## アーキテクチャ哲学 - Feature-Sliced Design (FSD)

このプロジェクトは、保守可能なアーキテクチャのためにFeature-Sliced Designの原則に従っています：

### ディレクトリ構造の原則
```
src/
├── app/              # アプリケーション層
├── features/         # 機能層（各機能は独立したディレクトリ）
├── entities/         # エンティティ層（ドメインモデル）
├── shared/           # 共有層（共通ユーティリティ、API）
└── index.ts          # エントリーポイント
```

各層の内部構造：
- **最小限の階層**: 不要なネストは避け、フラットな構造を保つ
- **明確な命名**: `lib`や`model`のような汎用的な名前は避ける
- **index.ts**: 各モジュールの公開APIとして使用

### 従うべきFSDの原則

1. **分離**: 各モジュールは独立している必要があります
   - 気象機能は互いに直接インポートしてはいけません
   - モジュール間の通信には明示的なパブリックAPIを使用します

2. **明示的な依存関係**: 下位層からのみインポートします
   - `app` → `features` → `entities` → `shared`
   - 同じ層や上位層からは決してインポートしません

3. **パブリックAPI**: 各モジュールは明確なパブリックインターフェースを公開します
   - パブリックAPIのエントリーポイントとして `index.ts` ファイルを作成します
   - 内部実装の詳細は非公開に保ちます

### リファクタリングのガイドライン

コードを変更する際は以下の構造を維持してください：

1. **`shared/` に配置するもの**:
   - NWS APIクライアント関数
   - 共通の型とインターフェース
   - エラーハンドリングユーティリティ
   - ロギングシステム
   - メトリクス収集
   - ヘルスチェック機能
   - 設定管理（config）
   - ミドルウェア

2. **`entities/` に配置するもの**:
   - 気象データの型定義（Alert、Forecast、Period等）
   - ドメイン固有の定数や列挙型

3. **`features/` に配置するもの**:
   - 各機能の実装（ハンドラー、ビジネスロジック）
   - 機能固有のデータ変換・フォーマット処理
   - 入力値の検証スキーマ
   - 機能に閉じた型定義やユーティリティ

4. **`app/` に配置するもの**:
   - MCPサーバーの初期化
   - ツールの登録
   - トップレベルのエラーハンドリング

## テストアプローチ

現在、テストフレームワークは設定されていません。テストを実装する際は：
- 各FSD層を独立してテストする
- 層間の依存関係をモックする
- パブリックAPIのテストに焦点を当てる

## コードスタイル

- TypeScriptの厳密な型付けを使用する
- ES modulesを使用（相対インポートには`.js`拡張子を追加）
- Zodによるスキーマ検証を活用する
- エラーハンドリングは各層で適切に行う

## ロギングとデバッグ

### ロギング
- すべてのログは構造化ログ（JSON形式）で出力
- ログレベル: trace, debug, info, warn, error
- 環境変数 `LOG_LEVEL` で制御
- リクエストIDによるトレース追跡

### デバッグ
- `DEBUG_MODE=true` で詳細なデバッグ情報を出力
- `PRETTY_LOGS=true` で読みやすいログフォーマット
- MCP Inspector統合でインタラクティブなデバッグ

### 監視
- メトリクス収集（リクエスト数、エラー率、レスポンス時間）
- ヘルスチェック機能（メモリ使用量、API接続性）
- スロークエリの検出（`SLOW_OPERATION_THRESHOLD`で設定）

## 環境変数

| 変数名 | デフォルト値 | 説明 |
|--------|------------|------|
| LOG_LEVEL | info | ログレベル（trace/debug/info/warn/error） |
| DEBUG_MODE | false | デバッグモードの有効化 |
| PRETTY_LOGS | false | 読みやすいログフォーマット |
| LOG_TIMESTAMPS | true | ログにタイムスタンプを含める |
| SLOW_OPERATION_THRESHOLD | 1000 | スロークエリの閾値（ミリ秒） |
| API_TIMEOUT | 30000 | APIタイムアウト（ミリ秒） |
| API_RETRY_ATTEMPTS | 3 | APIリトライ回数 |